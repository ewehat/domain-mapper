# Domain Router для Keenetic + Entware

**Domain Router** — набор shell-скриптов для автоматического управления маршрутизацией по доменным именам на роутерах Keenetic с установленным Entware.

## Возможности

- Автоматически разрешает (резолвит) доменные имена в IP-адреса.
- Добавляет статические маршруты в Keenetic через его API.
- Обновляет маршруты раз в день (через cron).
- Кэширует соответствия доменов и IP.
- Логирует все действия.
- Позволяет добавлять/удалять домены и чистить устаревшие маршруты.
- Безопасная обработка паролей (не отображаются в списке процессов).
- Автоматические повторные попытки при ошибках API.
- Валидация конфигурации и проверка соединения.

## Требования

- Роутер Keenetic с Entware.
- Доступ к консоли роутера и root-права.
- Настроенный доступ к API Keenetic (пользователь и пароль).

## Установка

1. Установите [Entware](https://github.com/Entware/Entware) на роутер Keenetic (если еще не установлен).
2. Клонируйте репозиторий на роутер или скачайте архив с файлами.
3. Запустите установочный скрипт:
   ```sh
   sh domain_router_config.sh
   ```
   Скрипт:
   - Скопирует основной файл `domain_router_main.sh` как `/opt/etc/domain-router/domain-router.sh`
   - Создаст конфиг, кэш, лог.
   - Добавит ежедневную задачу в cron.
   - Создаст удобную symlink-команду `/opt/bin/domain-router`

4. Отредактируйте параметры в `/opt/etc/domain-router/settings.conf` (доступ к Keenetic API и список DNS серверов).

5. Протестируйте конфигурацию:
   ```sh
   domain-router test-config
   ```

## Основные команды

Выполняются как:
```sh
domain-router <команда> [аргументы]
```

- `add <domain>` — добавить домен.
- `remove <domain>` — удалить домен.
- `update` — обновить маршруты для всех доменов.
- `force-update` — принудительно обновить маршруты (игнорирует кэш).
- `status` — показать статус, список доменов, кэш, активные маршруты.
- `cleanup` — удалить неиспользуемые маршруты.
- `test-config` — проверить конфигурацию и соединение с API роутера.

## Пример эксплуатации

1. Добавьте нужные домены:
   ```sh
   domain-router add example.com
   domain-router add another-site.org
   ```
2. Проверьте статус:
   ```sh
   domain-router status
   ```
3. (Опционально) Запустите обновление вручную:
   ```sh
   domain-router update
   ```

## Автоматизация

- Скрипт автоматически добавляет запуск обновления маршрутов в cron: ежедневно в 6:00 утра.
- Для ручного удаления всех маршрутов и/или полного удаления скрипта используйте:
  ```sh
  /opt/etc/domain-router/uninstall.sh
  ```

## Удаление

Выполните:
```sh
/opt/etc/domain-router/uninstall.sh
```
Скрипт удалит все связанные cron-задачи, файлы и/или только скрипт с сохранением конфигов (по выбору).

---

**Репозиторий:** [ewehat/domain-mapper](https://github.com/ewehat/domain-mapper)