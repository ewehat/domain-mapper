# Руководство разработчика Domain Router
# Domain Router Developer Guide

Этот документ описывает как настроить и использовать среду разработки для тестирования Domain Router.

## Структура файлов

```
domain-mapper/
├── README.md                    # Основная документация
├── domain_router_config.sh      # Скрипт установки для продакшена
├── domain_router_main.sh        # Основной скрипт маршрутизации
├── DEVELOPMENT.md              # Это руководство
├── dev-setup.sh                # Настройка среды разработки
├── test-runner.sh              # Автоматические тесты
├── mock-api-server.sh          # Мок-сервер Keenetic API
└── test-data/                  # Тестовые данные
    ├── settings.conf           # Конфигурация для тестов
    ├── domains.txt             # Список доменов для тестов
    ├── ip-cache.txt           # Кэш IP адресов
    └── domain-router.log      # Пример лог-файла
```

## Быстрый старт

### 1. Настройка среды разработки

```bash
# Настроить среду разработки
./dev-setup.sh

# Запустить автоматические тесты
./test-runner.sh
```

### 2. Ручное тестирование

После выполнения `dev-setup.sh` все файлы будут скопированы в `/tmp/domain-router-dev/`:

```bash
# Перейти в рабочую директорию
cd /tmp/domain-router-dev

# Проверить конфигурацию
./dr test-config

# Показать текущий статус
./dr status

# Добавить домен
./dr add example.org

# Обновить маршруты
./dr update

# Удалить домен
./dr remove example.org
```

### 3. Тестирование с мок-сервером API

Для более реалистичного тестирования можно запустить мок-сервер:

```bash
# В первом терминале - запустить мок-сервер
./mock-api-server.sh 8080

# Во втором терминале - изменить конфигурацию
cd /tmp/domain-router-dev
# Отредактировать settings.conf: KEENETIC_HOST="localhost:8080"
./dr test-config
```

## Файлы конфигурации

### settings.conf
Основные настройки для подключения к роутеру:
- `KEENETIC_HOST` - IP адрес или hostname роутера
- `KEENETIC_USER` - имя пользователя для API
- `KEENETIC_PASS` - пароль для API
- `VPN_INTERFACE` - интерфейс для маршрутизации
- `DNS_SERVERS` - DNS серверы через запятую

### domains.txt
Список доменов для маршрутизации, один домен на строку.
Строки начинающиеся с `#` игнорируются.

### ip-cache.txt
Кэш соответствий IP адресов и доменов в формате:
```
IP_ADDRESS DOMAIN1,DOMAIN2,DOMAIN3
```

## Команды для тестирования

| Команда | Описание |
|---------|----------|
| `test-config` | Проверка конфигурации и подключения |
| `status` | Показать текущий статус и кэш |
| `add <domain>` | Добавить домен в список |
| `remove <domain>` | Удалить домен из списка |
| `update` | Обновить маршруты для всех доменов |
| `force-update` | Принудительно обновить все маршруты |
| `cleanup` | Удалить неиспользуемые маршруты |

## Отладка

### Логи
Все операции записываются в `domain-router.log`. Для просмотра последних записей:
```bash
tail -f /tmp/domain-router-dev/domain-router.log
```

### Режим разработки
В среде разработки функция `keenetic_api_request` заменена на заглушку, которая:
- Выводит информацию о запросах в консоль
- Возвращает фиктивные успешные ответы
- Не выполняет реальные API вызовы

### Проверка файлов
```bash
# Проверить содержимое кэша
cat /tmp/domain-router-dev/ip-cache.txt

# Проверить список доменов
cat /tmp/domain-router-dev/domains.txt

# Проверить конфигурацию
cat /tmp/domain-router-dev/settings.conf
```

## Структура тестов

`test-runner.sh` выполняет следующие тесты:
1. Проверка конфигурации
2. Показ начального статуса
3. Добавление нового домена
4. Показ статуса после добавления
5. Обновление маршрутов
6. Принудительное обновление
7. Очистка неиспользуемых маршрутов
8. Удаление домена
9. Финальная проверка статуса

## Модификация для тестирования

Для добавления новых тестов или изменения поведения:

1. Отредактируйте файлы в `test-data/`
2. Запустите `./dev-setup.sh` для применения изменений
3. Выполните нужные тесты

## Мок-сервер API

`mock-api-server.sh` предоставляет следующие эндпоинты:
- `GET /rci/system` - информация о системе
- `GET /rci/ip/route` - список маршрутов
- `POST /rci/ip/route` - добавление маршрута
- `DELETE /rci/ip/route` - удаление маршрута

Логи запросов сохраняются в `/tmp/mock-api.log`.

## Требования

Для работы среды разработки необходимо:
- POSIX-совместимая shell (sh, bash, dash)
- Стандартные утилиты: grep, sed, awk, cut, sort
- Для мок-сервера: netcat, python3 или python2

## Очистка

Для очистки среды разработки:
```bash
rm -rf /tmp/domain-router-dev
rm -f /tmp/mock-api.log
```